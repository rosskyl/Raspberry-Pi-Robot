import RPi.GPIO as GPIO
from time import sleep
from os import stat

MOTOR_EN_1_PIN = 14
MOTOR_A_1_PIN = 15
MOTOR_B_1_PIN = 18

MOTOR_EN_2_PIN = 23
MOTOR_A_2_PIN = 24
MOTOR_B_2_PIN = 25


def mixXY(x, y):
	"""
	mixes x and y from a joystick to values for a 2 motor drive system
	input: x (int or float), y (int or float)
	output: (leftMotor (float), rightMotor (float)) tuple
	"""
	leftMotor = y + x
	rightMotor = y - x

	return (leftMotor, rightMotor)

def setMotorPWMS(leftMotor, rightMotor):
    #left motor
    if leftMotor < -100:
        leftMotor = -100
    elif leftMotor > 100:
        leftMotor = 100
    print("left Motor: ", leftMotor)
    if leftMotor == 0:
        GPIO.output(MOTOR_EN_1_PIN, 0)
        motor1A.stop()
        motor1B.stop()
    elif leftMotor < 0:
        GPIO.output(MOTOR_EN_1_PIN, 1)
        motor1A.stop()
        motor1B.ChangeDutyCycle(abs(leftMotor))
    else:
        GPIO.output(MOTOR_EN_1_PIN, 1)
        motor1A.ChangeDutyCycle(leftMotor)
        motor1B.stop()

    #right motor
    if rightMotor < -100:
        rightMotor = -100
    elif rightMotor > 100:
        rightMotor = 100
    print("right motor: ", rightMotor)
    if rightMotor == 0:
        GPIO.output(MOTOR_EN_2_PIN, 0)
        motor2A.stop()
        motor2B.stop()
    elif rightMotor < 0:
        GPIO.output(MOTOR_EN_2_PIN, 1)
        motor2A.stop()
        motor2B.ChangeDutyCycle(abs(rightMotor))
    else:
        GPIO.output(MOTOR_EN_2_PIN, 1)
        motor2A.ChangeDutyCycle(rightMotor)
        motor2B.stop()



GPIO.setwarnings(False)

#setup
GPIO.setmode(GPIO.BCM)
GPIO.setup(MOTOR_EN_1_PIN, GPIO.OUT)
GPIO.setup(MOTOR_A_1_PIN, GPIO.OUT)
GPIO.setup(MOTOR_B_1_PIN, GPIO.OUT)

GPIO.setup(MOTOR_EN_2_PIN, GPIO.OUT)
GPIO.setup(MOTOR_A_2_PIN, GPIO.OUT)
GPIO.setup(MOTOR_B_2_PIN, GPIO.OUT)

motor1A = GPIO.PWM(MOTOR_A_1_PIN, 50)
motor1B = GPIO.PWM(MOTOR_B_1_PIN, 50)
motor2A = GPIO.PWM(MOTOR_A_2_PIN, 50)
motor2B = GPIO.PWM(MOTOR_B_2_PIN, 50)
motor1A.start(0)
motor1B.start(0)
motor2A.start(0)
motor2B.start(0)


if len(argv) <= 2:
    print("Need to call with x and y from commandline")
else:
    motorPWM = mixXY(int(argv[1]), int(argv[2]))
    leftMotorPWM = motorPWM[0]
    rightMotorPWM = motorPWM[1]
    setMotorPWMS(leftMotorPWM, rightMotorPWM)
    while True:
        pass


##file = open("values.txt", 'r')
v##alues = file.readlines()[0].split()
file.close()
time = stat("values.txt").st_mtime
file = open("values.txt", 'r')
values = file.readlines()[0].split()
file.close()
motorPWM = mixXY(int(values[0]), int(values[1]))
print(values)
print(stat("values.txt").st_mtime)
leftMotorPWM = motorPWM[0]
rightMotorPWM = motorPWM[1]
setMotorPWMS(leftMotorPWM, rightMotorPWM)
sleep(1)
while True:
    try:
        if time != stat("values.txt").st_mtime:
            print("changed")
            file = open("values.txt", 'r')
            values = file.readlines()[0].split()
            file.close()
            motorPWM = mixXY(int(values[0]), int(values[1]))
            print(values)
            print(stat("values.txt").st_mtime)
            leftMotorPWM = motorPWM[0]
            rightMotorPWM = motorPWM[1]
            setMotorPWMS(leftMotorPWM, rightMotorPWM)
            sleep(1)

    except IndexError:
        pass
